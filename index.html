<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <meta name="theme-color" content="#0b1220" />
  <title>ProgressFit</title>

  <link rel="manifest" href="manifest.webmanifest" />
  <link rel="apple-touch-icon" href="apple-touch-icon.png" />
  <link rel="icon" type="image/png" sizes="192x192" href="icon-192.png" />
  <link rel="icon" type="image/png" sizes="512x512" href="icon-512.png" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-title" content="ProgressFit" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />

  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <style>
    :root{
      --bg:#0b1220;
      --border: rgba(255,255,255,.08);
      --text:#e8eefc;
      --muted:#9fb0d6;
      --good:#7CFF8C;
      --radius:16px;
      --shadow: 0 18px 60px rgba(0,0,0,.35);
    }
    *{box-sizing:border-box}
    body{
      margin:0; color:var(--text);
      font-family:-apple-system,BlinkMacSystemFont,"Hiragino Sans","Noto Sans JP",sans-serif;
      background: radial-gradient(1200px 800px at 30% -10%, rgba(106,227,255,.18), transparent 55%), var(--bg);
      padding: 14px 12px;
    }
    .phone{ max-width: 430px; margin: 0 auto; min-height: calc(100dvh - 28px); display:flex; flex-direction:column; gap:12px; }
    
    /* ヘッダー・ロゴ */
    .top{ display:flex; align-items:center; justify-content:space-between; }
    .brand{ display:flex; gap:10px; align-items:center; }
    .logo{
      width:40px; height:40px; border-radius:14px;
      background: url('icon-192.png') no-repeat center center / cover, linear-gradient(135deg,rgba(106,227,255,.2),rgba(167,139,250,.2));
      box-shadow:var(--shadow); flex:0 0 auto; cursor:pointer;
    }
    .logo.spinning{ animation: spin 0.9s linear infinite; }
    @keyframes spin{ from{transform:rotate(0deg)} to{transform:rotate(360deg)} }
    .title{ font-size:18px; font-weight:900; }

    /* チップ・ボタン */
    .actions{ display:flex; gap:8px; }
    .chip{ border:1px solid var(--border); background:rgba(255,255,255,.03); border-radius:999px; padding:8px 12px; font-size:12px; font-weight:900; }
    .btn-add{ background:rgba(106,227,255,.15); color:var(--text); cursor:pointer; }

    /* メインKPI */
    .kpis{ display:grid; grid-template-columns: 1fr 1fr; gap:10px; }
    .kpi{ border:1px solid var(--border); background:rgba(255,255,255,.03); border-radius:var(--radius); padding:12px; }
    .klabel{ font-size:11px; color:var(--muted); font-weight:900; }
    .kval{ display:flex; align-items:baseline; gap:4px; margin-top:4px; }
    .knum{ font-size:24px; font-weight:900; }
    .kunit{ font-size:11px; color:var(--muted); }

    /* パネルエリア */
    .panel{ border:1px solid var(--border); background:rgba(255,255,255,.03); border-radius:var(--radius); padding:12px; flex:1; display:flex; flex-direction:column; }
    .tabs{ display:flex; gap:6px; margin-bottom:12px; overflow-x:auto; padding-bottom:4px; }
    .tab{ padding:8px 12px; border-radius:999px; border:1px solid var(--border); font-size:12px; white-space:nowrap; cursor:pointer; color:var(--muted); }
    .tab.active{ background:rgba(167,139,250,.2); color:var(--text); border-color:rgba(167,139,250,.4); }

    .chartWrap{ flex:1; min-height:200px; position:relative; }
    .moreGrid{ display:grid; grid-template-columns: 1fr 1fr; gap:10px; }
    .moreItem{ padding:10px; border:1px solid var(--border); border-radius:12px; background:rgba(255,255,255,.02); }

    /* モーダル */
    .modalBg{ position:fixed; inset:0; background:rgba(0,0,0,.7); display:none; align-items:center; justify-content:center; padding:16px; z-index:100; }
    .modal{ width:100%; max-width:400px; background:#161d2b; border-radius:20px; padding:20px; border:1px solid var(--border); }
    .form{ display:grid; grid-template-columns: 1fr 1fr; gap:10px; }
    .f-full{ grid-column: span 2; }
    .field label{ display:block; font-size:11px; color:var(--muted); margin-bottom:4px; }
    .field input{ width:100%; background:rgba(0,0,0,.2); border:1px solid var(--border); color:#fff; padding:8px; border-radius:8px; font-size:16px; }
    .m-btns{ display:flex; gap:10px; margin-top:20px; justify-content:flex-end; }
    .btn{ padding:10px 20px; border-radius:999px; border:none; font-weight:900; cursor:pointer; }
    .btn-save{ background:var(--good); color:#000; }
  </style>
</head>
<body>

<div class="phone">
  <div class="top">
    <div class="brand">
      <div class="logo" id="logoBtn"></div>
      <div class="title">ProgressFit</div>
    </div>
    <div class="actions">
      <div class="chip btn-add" id="openAdd">＋データ</div>
    </div>
  </div>

  <div class="kpis">
    <div class="kpi">
      <div class="klabel">体重</div>
      <div class="kval"><span class="knum" id="k_weight">—</span><span class="kunit">kg</span></div>
    </div>
    <div class="kpi">
      <div class="klabel">体脂肪率</div>
      <div class="kval"><span class="knum" id="k_bf">—</span><span class="kunit">%</span></div>
    </div>
  </div>

  <div class="panel">
    <div class="tabs" id="metricTabs">
      <div class="tab active" data-m="weight_kg">体重</div>
      <div class="tab" data-m="body_fat_pct">体脂肪率</div>
      <div class="tab" data-m="skeletal_muscle_kg">骨格筋量</div>
      <div class="tab" data-m="waist">ウエスト</div>
    </div>
    
    <div id="trendView" class="chartWrap"><canvas id="trendChart"></canvas></div>
    
    <div id="moreView" style="display:none;">
      <div class="moreGrid" id="moreGrid"></div>
    </div>

    <div style="display:flex; gap:10px; margin-top:15px;">
      <button class="tab active" id="btnTrend">Trend</button>
      <button class="tab" id="btnMore">More</button>
    </div>
  </div>
</div>

<div class="modalBg" id="modalAdd">
  <div class="modal">
    <h3 style="margin:0 0 15px 0">データ入力</h3>
    <div class="form">
      <div class="field f-full"><label>測定日</label><input type="date" id="a_date"></div>
      <div class="field"><label>体重(kg)</label><input type="number" step="0.1" id="a_weight"></div>
      <div class="field"><label>BMI</label><input type="number" step="0.1" id="a_bmi"></div>
      <div class="field"><label>ウエスト</label><input type="number" step="0.1" id="a_waist"></div>
      <div class="field"><label>体脂肪量(kg)</label><input type="number" step="0.1" id="a_fm"></div>
      <div class="field"><label>内臓脂肪指数</label><input type="number" id="a_vfi"></div>
      <div class="field"><label>体脂肪率(%)</label><input type="number" step="0.1" id="a_bf"></div>
      <div class="field"><label>骨格筋量(kg)</label><input type="number" step="0.1" id="a_smm"></div>
      <div class="field"><label>基礎代謝(kcal)</label><input type="number" id="a_bmr"></div>
      <div class="field"><label>四肢除脂肪(kg)</label><input type="number" step="0.1" id="a_lbm"></div>
    </div>
    <div class="m-btns">
      <button class="btn" onclick="$('modalAdd').style.display='none'">閉じる</button>
      <button class="btn btn-save" id="saveBtn">保存</button>
    </div>
  </div>
</div>

<script>
const ENDPOINT = '【あなたのGASのURL】';
const TOKEN = 'CHANGE_ME_TOKEN';

const METRICS = {
  weight_kg: { name:'体重', unit:'kg' },
  body_fat_pct: { name:'体脂肪率', unit:'%' },
  fat_mass_kg: { name:'体脂肪量', unit:'kg' },
  skeletal_muscle_kg: { name:'骨格筋量', unit:'kg' },
  bmi: { name:'BMI', unit:'' },
  waist: { name:'ウエスト', unit:'cm' },
  visceral_fat_idx: { name:'内臓脂肪', unit:'' },
  bmr: { name:'基礎代謝', unit:'kcal' },
  limb_lbm: { name:'四肢除脂肪', unit:'kg' }
};

const $ = id => document.getElementById(id);
let rows = [], chart = null, currentMetric = 'weight_kg';

async function loadData() {
  $('logoBtn').classList.add('spinning');
  const cb = 'jsonp_' + Date.now();
  const script = document.createElement('script');
  script.src = `${ENDPOINT}?action=read&token=${TOKEN}&callback=${cb}`;
  
  const res = await new Promise(resolve => {
    window[cb] = data => { resolve(data); delete window[cb]; script.remove(); };
    document.body.appendChild(script);
  });

  rows = res.rows.map(r => {
    let obj = {};
    res.header.forEach((h, i) => obj[h] = r[i]);
    return obj;
  }).sort((a,b) => a.date.localeCompare(b.date));

  render();
  $('logoBtn').classList.remove('spinning');
}

function render() {
  if(!rows.length) return;
  const last = rows[rows.length-1];
  $('k_weight').textContent = last.weight_kg || '—';
  $('k_bf').textContent = last.body_fat_pct || '—';
  
  updateChart();
  updateMore(last);
}

function updateChart() {
  const ctx = $('trendChart').getContext('2d');
  if(chart) chart.destroy();
  chart = new Chart(ctx, {
    type: 'line',
    data: {
      labels: rows.map(r => r.date),
      datasets: [{
        data: rows.map(r => r[currentMetric]),
        borderColor: '#7CFF8C', tension: 0.3, fill: false, pointRadius: 2
      }]
    },
    options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } }
  });
}

function updateMore(last) {
  const grid = $('moreGrid');
  grid.innerHTML = '';
  Object.keys(METRICS).forEach(key => {
    const div = document.createElement('div');
    div.className = 'moreItem';
    div.innerHTML = `<div class="klabel">${METRICS[key].name}</div><div style="font-weight:900">${last[key] || '—'}<small style="color:var(--muted);margin-left:2px">${METRICS[key].unit}</small></div>`;
    grid.appendChild(div);
  });
}

// フォームリセット & 今日付セット
function resetForm() {
  const now = new Date();
  const y = now.getFullYear();
  const m = String(now.getMonth() + 1).padStart(2, '0');
  const d = String(now.getDate()).padStart(2, '0');
  $('a_date').value = `${y}-${m}-${d}`;
  ['a_weight','a_bmi','a_waist','a_fm','a_vfi','a_bf','a_smm','a_bmr','a_lbm'].forEach(id => $(id).value = '');
}

$('openAdd').onclick = () => { resetForm(); $('modalAdd').style.display='flex'; };

$('saveBtn').onclick = async () => {
  const params = new URLSearchParams({
    action: 'upsert', token: TOKEN,
    date: $('a_date').value,
    weight_kg: $('a_weight').value,
    bmi: $('a_bmi').value,
    waist: $('a_waist').value,
    fat_mass_kg: $('a_fm').value,
    visceral_fat_idx: $('a_vfi').value,
    body_fat_pct: $('a_bf').value,
    skeletal_muscle_kg: $('a_smm').value,
    bmr: $('a_bmr').value,
    limb_lbm: $('a_lbm').value
  });

  $('saveBtn').disabled = true;
  await fetch(ENDPOINT, { method: 'POST', mode: 'no-cors', body: params });
  setTimeout(() => {
    $('modalAdd').style.display = 'none';
    $('saveBtn').disabled = false;
    loadData();
  }, 1000);
};

document.querySelectorAll('#metricTabs .tab').forEach(tab => {
  tab.onclick = () => {
    document.querySelectorAll('#metricTabs .tab').forEach(t => t.classList.remove('active'));
    tab.classList.add('active');
    currentMetric = tab.dataset.m;
    updateChart();
  };
});

$('btnTrend').onclick = () => {
  $('trendView').style.display = 'block'; $('moreView').style.display = 'none';
  $('btnTrend').classList.add('active'); $('btnMore').classList.remove('active');
};
$('btnMore').onclick = () => {
  $('trendView').style.display = 'none'; $('moreView').style.display = 'block';
  $('btnTrend').classList.remove('active'); $('btnMore').classList.add('active');
};

$('logoBtn').onclick = loadData;
loadData();
</script>
</body>
</html>
